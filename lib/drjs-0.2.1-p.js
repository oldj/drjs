/*
drjs.js
- A JavaScript graphics library based on DOM and CSS.

Version: 0.2.1
Copyright (c) 2008 oldJ, Sansi.Org
License: LGPL

LastUpdate: 2008-8-16
*/

(function(){var pm={dot2dom:function(dot){var div=document.createElement("div");div.style.position="absolute";div.style.left=dot[0]+"px";div.style.top=dot[1]+"px";div.style.width=dot[2]+"px";div.style.height=dot[3]+"px";div.style.overflow="hidden";div.style.backgroundColor=dot[4]||"#000";div.style.borderWidth=0;return div},dotStroke:function(dot,stroke){if(stroke>1){var v=Math.round((stroke)/2)dot[0]-=v;dot[1]-=v;dot[2]+=v;dot[3]+=v}return dot},merge:function(dots){var dot=[],i,j,l,d0,d1;while(dots[0])dot.push.apply(dot,dots.splice(0,1)[0]);return dot},newColor:function(colorIdx){var clr="";colorIdx=typeof(colorIdx)=="number"?colorIdx:pv.colors.length;if(pv.colors[colorIdx]){clr=pv.colors[colorIdx]}else{clr="#";while(clr.length<7)clr+=Math.floor(Math.random()*16).toString(16)}return clr}};var pv={colors:["#FF0000","#FF9900","#FFFF00","#00FF00","#0000FF","#840084","#FF00FF","#008200","#FF0066","#CEDF39","#D5FF00","#848200","#00FF84","#0082FF","#84FFFF","#004184","#8482FF","#8400FF","#FF0084","#844100","#FF8242","#848242","#FF8500","#BEB05A","#BEB0E1"]};var drFunc={arc:function(canvas,p){var a=p[0],b=p[1],angle1=Math.min(p[2],p[3])%360,angle2=Math.max(p[2],p[3])%360,noBorder=p[4],f=[],ray1,ray2;if(angle2-angle1>=360)return drFunc.oval(canvas,{a:a,b:b});var getIntersection=function(a,b,c,angle){var x=a*b*Math.sqrt(1/(b*b+a*a*c*c)),sign=Math.cos(Math.PI*angle/180)>0?1:-1;return x*sign+a};var c1=Math.tan(Math.PI*angle1/180),c2=Math.tan(Math.PI*angle2/180);ray1=function(x){return c1*x};ray2=function(x){return c2*x};var oval=function(sign,x0,x1){return{f:function(x){return b*(1+sign*Math.sqrt(1-(x-a)*(x-a)/(a*a)))},interval:[x0,x1]}}var x1=getIntersection(a,b,c1,angle1),x2=getIntersection(a,b,c2,angle2),y1=ray1(x1-a)+b,y2=ray2(x2-a)+b;if(!noBorder){f.push.apply(f,drFunc.polyline(canvas,[[x1,y1],[a,b],[x2,y2]]))}if(angle1<=-180){if(angle2<=-180){f.push(oval(1,x2,x1))}else if(angle2<=0){f.push(oval(1,0,x1));f.push(oval(-1,0,x2))}else{f.push(oval(1,0,x1));f.push(oval(-1,0,a*2));f.push(oval(1,x2,a*2))}}else if(angle1<=0){if(angle2<=0){f.push(oval(-1,x1,x2))}else if(angle2<180){f.push(oval(-1,x1,a*2));f.push(oval(1,x2,a*2))}else{f.push(oval(-1,x1,a*2));f.push(oval(1,0,a*2));f.push(oval(-1,0,x2))}}else if(angle1<=180){if(angle2<=180){f.push(oval(1,x2,x1))}else{f.push(oval(1,0,x1));f.push(oval(-1,0,x2))}}else{f.push(oval(-1,x1,x2))}return f},box:function(canvas,p){var shape=new drjs.Shape(canvas),css0={width:p[0]+"px",height:p[1]+"px",borderStyle:"solid",borderWidth:"1px",borderColor:"#000"},css=p[2]||{},k;for(k in css0)if(!css[k])css[k]=css0[k];for(k in css)shape.container.style[k]=css[k];return shape.paint()},dot:function(canvas,p){return[[p[0],p[1],1,1]]},img:function(canvas,p){return(new drjs.Shape(canvas)).setImg(p[0],p[1]||{}).paint()},line:function(canvas,p){var a,b,x0=p[0][0],y0=p[0][1],x1=p[1][0],y1=p[1][1];if(x0==x1){return[[Math.min(x0,x1),Math.min(y0,y1),1,Math.abs(y1-y0)+1]]}else{a=(y0-y1)/(x0-x1);b=(x0*y1-x1*y0)/(x0-x1);return[{f:function(x){return a*x+b},interval:[Math.min(x0,x1),Math.max(x0,x1)]}]}},polyline:function(canvas,p){var i,l=p.length,functions=[];for(i=1;i<l;i++){functions.push(drFunc.line(canvas,[p[i-1],p[i]])[0])}return functions},polygon:function(canvas,p){p.push(p[0]);return drFunc.polyline(canvas,p)},oval:function(canvas,p){var a=p[0],b=p[1];return[{f:function(x){return b*(1+Math.sqrt(1-(x-a)*(x-a)/(a*a)))},interval:[0,a*2]},{f:function(x){return b*(1-Math.sqrt(1-(x-a)*(x-a)/(a*a)))},interval:[0,a*2]}]},rectangle:function(canvas,p){var x=p[0],y=p[1],x1=x+p[2],y1=y+p[3];return drFunc.polygon(canvas,[[x,y],[x1,y],[x1,y1],[x,y1]])},string:function(canvas,p,color){var css=p[1]||{};if(color)css.color=color;return(new drjs.Shape(canvas)).setText(p[0],css).paint()}}drjs={addFunc:function(name,func){drFunc[name]=func},Canvas:function(p,parent){p=typeof(p)=="object"?p:{width:480,height:360};this.container=document.createElement("div");this.shapes=[];this.items={};this.groups={};this.parent=parent?(typeof(parent)=="string"?document.getElementById(parent):parent):document.getElementsByTagName("body")[0];this._colorIdx=0;this.style({position:"relative",padding:0,margin:0,width:p.width?p.width+"px":"480px",height:p.height?p.height+"px":"360px",lineHeight:p.lineHeight?p.lineHeight+"px":"20px",overflow:"hidden",backgroundColor:p.backgroundColor||"#fff",backgroundImage:p.backgroundImage||"none",borderWidth:p.borderWidth?p.borderWidth+"px":0,borderStyle:p.borderStyle||"solid",borderColor:p.borderColor||"#000"})},Shape:function(canvas,dots,name){if(!canvas)return null;this.canvas=canvas;this.dots=dots||[];this.canvas.shapes.push(this);this.name=name?name:"shape_"+this.canvas.shapes.length;this.container=document.createElement("div");this.container.style.position="absolute";this.container.setAttribute("id","drjs_shape_"+this.name);this.init()},Item:function(canvas,name){this.canvas=canvas;this.name=name;this.shapes=[];this.container=document.createElement("div");this.container.style.position="absolute";this.container.setAttribute("id","drjs_item_"+this.name);this.canvas.items[this.name]=this;this.canvas.container.appendChild(this.container);return this}};drjs.Canvas.prototype.colorIdx=function(){return this._colorIdx++};drjs.Canvas.prototype.count=function(){return this.container.getElementsByTagName("div").length};drjs.Canvas.prototype.style=function(obCSS){for(var k in obCSS){this.container.style[k]=obCSS[k]}};drjs.Canvas.prototype.newColor=function(){return pm.newColor(this.colorIdx())};drjs.Canvas.prototype.show=function(){this.parent.appendChild(this.container)};drjs.Canvas.prototype.clear=function(){this.container.innerHTML=""};drjs.Canvas.prototype.draw=function(drawType,parameters,left,top,color,fill,stroke){var functions,shape;if(typeof(drawType)=="string"&&(drawType in drFunc)){functions=drFunc[drawType](this,parameters,color)}else if(drawType instanceof Array){functions=drawType}else if(typeof(drawType)=="object"){functions=[drawType]}else{throw new Error("drawType Error!");}if(functions instanceof drjs.Shape)shape=functions;else shape=new drjs.Shape(this,this.mkDots(functions,color,fill,stroke));shape.setTop(top||0);shape.setLeft(left||0);shape.paint();return shape};drjs.Canvas.prototype.mkDots=function(functions,color,fill,stroke){color=color||pm.newColor(this.colorIdx());stroke=stroke||1;var i,f,x,y,x0=0,x1=0,dots=[],dot,tmp;if(!fill){for(i=0;i<functions.length;i++){dots[i]=[];if((functions[i]instanceof Array)){functions[i][4]=color;dots[i].push(functions[i]);continue}f=functions[i].f;x0=functions[i].interval[0];x1=functions[i].interval[1];for(x=x0;x<=x1;x++){y=Math.round(f(x));if(dots[i][0]){dot=dots[i][dots[i].length-1];if(dot[1]==y&&dot[3]==1){dot[2]++}else if(dot[1]<=y&&dot[1]+dot[3]>=y&&Math.round(f(x-1))!=y){dot[3]=Math.abs(dot[1]-y);if(dot[3]==0)dot[3]=1;dots[i].push([x,y,1,1,color])}else if(Math.abs(y-dot[1])>1){tmp=Math.round(f(x-0.5));if(tmp==dot[1])tmp+=(y>dot[1]?1:-1);if(Math.abs(tmp-dot[1])>1){if(dot[2]>1){dots[i].push([x-1,Math.min(tmp,dot[1]),1,Math.abs(tmp-dot[1]),color])}else{if(tmp>dot[1]){dot[3]=Math.abs(tmp-dot[1]);dot[1]=Math.min(tmp,dot[1])}else{dot[3]=Math.abs(tmp-dot[1])+dot[3]-1;dot[1]=Math.min(tmp+1,dot[1])}}}dots[i].push([x,Math.min(tmp,y),1,Math.abs(tmp-y)+1,color])}else{dots[i].push([x,y,1,1,color])}}else{dots[i].push([x,y,1,1,color])}}}dots=pm.merge(dots)}else{var ys=[],funcLen=functions.length;for(i=0;i<funcLen;i++){if(functions[i].interval&&functions[i].interval[0]<x0)x0=functions[i].interval[0];if(functions[i].interval&&functions[i].interval[1]>x1)x1=functions[i].interval[1]}for(x=x0;x<x1;x++){ys.length=0;for(i=0;i<funcLen;i++){if(functions[i].interval&&x>=functions[i].interval[0]&&x<=functions[i].interval[1]){tmp=Math.round(functions[i].f(x));if(!isNaN(tmp))ys.push(tmp)}}if(ys.length<2)continue;ys.sort(function(a,b){return a-b});if(ys.length>1&&ys[0]==ys[1])ys.shift();for(i=0;i<ys.length-1;i+=2){if(dots[0]){dot=dots[dots.length-1];if(dot[0]+dot[2]==x&&dot[1]==ys[i]&&ys[i+1]-ys[i]+1==dot[3]){dot[2]++}else{dots.push([x,ys[i],1,ys[i+1]-ys[i]+1,color])}}else{dots.push([x,ys[i],1,ys[i+1]-ys[i]+1,color])}}}}if(!fill&&stroke>1){for(i=0;i<dots.length;i++)dots[i]=pm.dotStroke(dots[i],stroke)}return dots};drjs.Canvas.prototype.newItem=function(name){return new drjs.Item(this,name)};drjs.Canvas.prototype.chart=function(chartName,chartType,width,height,values,labels,colors,stroke){var item=this.newItem(chartName),val=[],max=Math.max.apply(Math.max,values),len=values.length,sum=0,i,c;for(i=0;i<len;i++)sum+=values[i];if(chartType=="bar"){var sp=2,w=(width+sp)/len,h=0,c=colors&&colors[0]?colors[0]:this.newColor();for(i=0;i<len;i++){h=Math.round(height*values[i]/max);item.addShape(this.draw("rectangle",[Math.round(w*i),height-h,Math.round(w-sp),h],0,0,c,true))}}else if(chartType=="pie"){var a=Math.round(width/2),b=Math.round(height/2);var angles=[-90],sum2=0;for(i=0;i<len;i++){sum2+=values[i];angles.push(360*sum2/sum-90)}for(i=1;i<angles.length;i++){item.addShape(this.draw("arc",[a,b,angles[i-1],angles[i]],0,0,colors?(colors[i-1]?colors[i-1]:null):null,true))}}else if(chartType=="polyline"){var dots=[],w=width/len;for(i=0;i<len;i++){dots.push([Math.round(w*(i+0.5)),height-Math.round(height*values[i]/max)])}item.addShape(this.draw("polyline",dots,0,0,null,false,stroke||1))}return item};drjs.Shape.prototype={addDots:function(dots){this.dots.push.apply(this.dots,dots);this.init(dots);return this},init:function(dots){var df=document.createDocumentFragment?document.createDocumentFragment():document.createElement("div"),dot;dots=dots||this.dots;for(var i=0,l=dots.length;i<l;i++){dot=pm.dot2dom(dots[i]);df.appendChild(dot)}this.container.appendChild(df);return this},paint:function(){this.canvas.container.appendChild(this.container);return this},remove:function(){for(var i=0;i<this.canvas.shapes.length;i++){if(this.canvas.shapes[i]==this)this.canvas.shapes.splice(i,1)}this.canvas.removeChild(this.container);return null},setImg:function(src,style){var img=this.container.getElementsByTagName("img")[0];if(!img){img=document.createElement("img");this.container.appendChild(img)}if(style&&typeof(style)=="object"){for(var k in style)img.style[k]=style[k]}img.src=src;return this},setName:function(name){this.name=name;this.container.setAttribute("id","drjs_"+this.name);return this},setLeft:function(v){this.container.style.left=v+"px";return this},setTop:function(v){this.container.style.top=v+"px";return this},setText:function(str,style){this.text=str;if(!this.textContainer){this.textContainer=document.createElement("p");this.textContainer.style.fontSize="12px";this.textContainer.style.color="#000";this.textContainer.style.fontFamily="Courier New, Verdana, Arial";this.container.appendChild(this.textContainer)}if(style&&typeof(style)=="object"){for(var k in style)this.textContainer.style[k]=style[k]}this.textContainer.innerHTML=str;return this}}drjs.Item.prototype={addShape:function(shapes){if(!(shapes instanceof Array))shapes=[shapes];for(var i=0;i<shapes.length;i++)if(shapes[i]instanceof drjs.Shape){this.container.appendChild(shapes[i].container);this.shapes.push(shapes[i].container)}return this},locate:function(left,top){this.container.style.left=left+"px";this.container.style.top=top+"px";return this},remove:function(){delete this.canvas.items[this.name];this.container.parentNode.removeChild(this.container);return null}}})();